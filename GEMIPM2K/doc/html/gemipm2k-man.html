<!DOCTYPE doctype PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
  <meta http-equiv="Content-Type"
 content="text/html; charset=iso-8859-1">
  <meta name="GENERATOR"
 content="Mozilla/4.7 [en] (WinNT; I) [Netscape]">
  <title>GEMIPM2K Description</title>
  <meta name="description" content="Version 3.0.0-PSI">
</head>
<body>
<h1><img alt="GEMS-icon" src="gems1.png"
 style="width: 48px; height: 48px;" align="left"> <font color="#000066">
GEMIPM2K version 2.2.3</font> </h1>
<h2>Standalone GEM-IPM-2 Solver of Chemical Equilibria by Gibbs Energy
Minimization<br>
</h2>
<hr size="2" width="100%">
<p> </p>
<h3><span style="color: rgb(255, 0, 0);">&lt;under construction&gt;</span><br>
</h3>
<h3>Contents</h3>
<blockquote>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#1-INTRO">1.
Introduction<br>
  </a></font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#2-STRUCTURE">2.
Structure of GEMIPM2K Code&nbsp; and its Data Exchange Intefaces <br>
  </a></font></p>
  <p><a href="#IPM2-OPERATION"><font face="Helvetica, Arial, sans-serif">2.1.
Brief overview of GEM IPM2 module operation</font></a></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#KERNEL">2.2.
The GEM-IPM2 Kernel (GEMIPM2K) and its Work Data Structure IPM (Multi) </a><br>
  </font></p>
  <p><a href="#DATACH"><font face="Helvetica, Arial, sans-serif">2.3.
The DATACH Structure for Chemical System Definition (CSD) Accessible to
both FMT and GEM parts</font></a></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#DATABR">2.4.
The DATABR Structure for the Node Data Bridge Composition and
Speciation data</a> <br>
  <br>
  </font><font face="Helvetica, Arial, sans-serif"> <a href="#TNODE">2.5.
The TNode Class - a Minimal Data Exchange
Interface for Coupling with Existing Transport Codes</a><br>
  </font><font face="Helvetica, Arial, sans-serif"><br>
  <a href="#TNODEARRAY">2.6. The TNodeArray Class - a Node Data Storage
for Developing New Coupled Codes</a></font><br>
  </p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#REQUIREMENTS">3.
Requirements for Programming </a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#CALLFROMCPP">3.1.
When the Calling (FMT)
Program is Written in C++</a><br>
  </font><font face="Helvetica, Arial, sans-serif"><br>
  <a href="#CALLFROMFORTRAN">3.2. When the Calling (FMT) Program is
Written in Fortran-90 </a></font><br>
  </p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#ALPHABETICAL">4.
Compilation and Linking on Various Platforms</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#GNUCPP_FOR">4.1.
GNU C++ (gcc - gfortran)</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#PGICPP_FOR">4.2.
Portland Group C++ (pgcc- pgf)</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#MSVCPP_DIGIFOR">4.3.
MS Visual C++ (with Digital Fortran)</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#BORLANDCPP">4.4.
Borland C++</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a
 href="#OTHER_COMPILERS">4.5. Other compilers and linkers</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#SVN_REP">4.6.
Subversion Repository of GEMIPM2K</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#INPUT_FILES">5.
Input Files</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#TEST_EXAMPLES">6.
Test Examples</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a href="#TEST_TNODE">6.1.
TNode Level</a><br>
  </font></p>
  <p><font face="Helvetica, Arial, sans-serif"><a
 href="#TEST_TNODEARRAY">6.2. TNodeArray Level</a><br>
  <a href="gemipm2k-man.html#FREEDATA"> </a></font></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><a
 href="#REFERENCES">7. References</a></p>
  <br>
  <hr size="2" width="100%"><br>
  <h2><a name="1-INTRO"></a>1. Introduction</h2>
  <p></p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Modern
approaches to reactive mass transport (RMT) or fluid mass transport
(FMT) modelling require simultaneous account for the mass transport of
contaminants through aqueous and/or gas phase in subsurface, together
with their
interaction with wall-rock minerals by means of (ad)sorption,
mineral (co)precipitation, dissolution, etc.&nbsp; These chemical
processes depend on the redox state of the system, are inherently
complex,
and may involve many phases and chemical species, some of which are
kinetically dependent. Such interactions may indirectly affect the mass
transport
via the porosity and permeability changes e.g. due to mineral
dissolution or
precipitation. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Direct
inclusion of all possible chemical reactions in the mass transport
model may render it intractable in 2D or 3D space.
If this is the case, the chemical model must be dramatically simplified
to a
few reactions, which makes its chemical plausibility doubtful. The
modeller must make (often arbitrary) decisions which chemical
interactions are relevant and which can be neglected. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">An
alternative approach would be to keep a complex enough chemical model
in a kind of "black box" which can be applied separately to each
node of the FMT model at each given time point <span
 style="font-style: italic;">t</span>.&nbsp; The&nbsp; input of
the "chemical black box" at time <span style="font-style: italic;">t</span>&nbsp;
is just the vector of bulk chemical composition <span
 style="font-style: italic;">b</span>
of the reactive part of the node, as well as temperature <span
 style="font-style: italic;">T</span>, pressure <span
 style="font-style: italic;">P</span>, and optionally, kinetic
constraints <span style="font-style: italic;">k</span> on some
reactions or amounts of certain components. Some or all of these inputs
could have been changed by the mass transport part on its previous
iteration time step <span style="font-style: italic;">t-</span>1.&nbsp;
  <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Now, the
"chemical black box" equilibration is applied
to each node independently at time point <span
 style="font-style: italic;">t</span>,
to produce changed speciation <span style="font-style: italic;">n</span>
(amounts of chemical species in all reactive
phases),&nbsp; new phase volumes, redox (Eh, pe of aqueous solution,
gas fugacities), chemical potentials of components, etc. This
procedure can also detect a disappearance of some phases or
appearance of some new phases in some nodes (e.g., by dissolution or
precipitation of solids). <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">After the
"chemistry" run over all nodes is
finished, the next time step of the FMT algorithm can be done for the
time point <span style="font-style: italic;">t</span>+1, using the
updated concentrations of mobile species (also pH, Eh, f(H2), ... ) in
aqueous
and/or gas phases at time <span style="font-style: italic;">t.</span>
The FMT part redistributes matter between nodes (under mass
concervation), thus producing corrected compositions of reactive part
of
each node. So, the coupled RMT algorithm actually runs over all nodes
twice at the time point <span style="font-style: italic;">t</span>:&nbsp;
once doing a mass transport iteration using node compositions obtained
earlier (at <span style="font-style: italic;">t</span>-1), and
then&nbsp; by applying the "chemical black box" to each node at time <span
 style="font-style: italic;">t</span>, producing the updated speciation
which will be used by the FMT part at the next time point&nbsp; <span
 style="font-style: italic;">t</span>+1.</p>
  <p style="font-family: Helvetica,Arial,sans-serif;">This
idea of "reactor-splitting" coupling is not really new and it has
already been implemented in a number of
coupled codes (PHREEQC, RockFlow, MCOTAC, ....). These codes
use different mass transport algorithms, but in most cases the same
type of chemical
solver based on the law of mass action (LMA) and the Newton-Raphson
method
for minimizing the mass balance deviations. However, another type of
chemical solvers based on Gibbs energy minimization (GEM) can also
be&nbsp;
coupled with the FMT codes. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Both LMA and
GEM can solve the so-called&nbsp; forward
chemical modeling problem, which consists in finding
concentrations (or
amounts) and activities of chemical species in aqueous and other phases
present
in a complex chemical system in an equilibrium state defined by
temperature <span style="font-style: italic;">T</span>, pressure <span
 style="font-style: italic;">P</span>, and the
system bulk composition <span style="font-style: italic;">b</span>. In
practice, calculations for
solving such problems range from trivial to complex,
depending on
the number of species, phases, and stoichiometry units. The complexity
further
increases when several phases-solutions with redox sensitive components
are
included in the mass balance; a typical case is the aqueous - solid
solution (Aq-SS) system which also involves a non-ideal fluid (gas
mixture) phase. Even more complex systems can be considered, e.g. those
involving (ad)sorption on several co-existing stable or metastable
sorbents. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Chemical
speciation problems were traditionally solved with help of the LMA
codes,
supported with tools for calculation of
Lippmann functions and saturation indexes. A good introduction
into modern LMA chemical speciation numerical
methods can be found in several textbooks [<a
 href="#Ref_Van-Zeggeren-1970">Van Zeggeren and Storey,
1970</a>; <a href="#Ref_Morel-Hering-1993">Morel and Hering, 1993</a>;
  <a href="#Ref_Bethke-1996">Bethke, 1996</a>] and in the manuals of
speciation codes such as PHREEQC [<a href="#Ref_Parkhurst-Appelo-1999">Parkhurst
and Appelo, 1999</a>] or CHESS
[<a href="#Ref_van-der-Lee-1998">van der Lee, 1998</a>]. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The
advantages of LMA - excellent mass balance accuracy and fast
convergence - are best revealed in the case of simple aqueous
speciation models with known stable pure solid phase assemblage and
known Eh and fugacities of gases. The LMA codes require thermodynamic
data only for the product species (usually aqueous/surface complexes,
minerals, and gases), but not for the master species (usually aqueous
ions) - this "input data economy" can also be viewed as an advantage in
some cases.<br>
  <br>
  <a name="CRITIQUE-LMA"></a>However,
solving with LMA code complex equilibria that involve the aqueous
electrolyte phase, many possible condensed phases including solid
solutions or fluids is,
in general, an inefficient and awkward process. Different approaches
are used in LMA chemical solvers. In the Geochemists Workbench [<a
 href="#Ref_Bethke-1996">Bethke,1996</a>],&nbsp; any pure mineral phase
is taken as master species. Because there is no way to mix master
species, this program cannot handle solid solutions or gas mixture at
all. Other LMA codes (such as PHREEQC) consider minerals and gases as
product species. As pointed by [<a href="#Ref_Reed-1982">Reed, 1982</a>],
usually no solids are taken into mass balance in the initial speciation
calculation; after it is done, the saturation indexes are computed for
each stoichiometrically feasible mineral phase, the mineral with the
highest oversaturation is included into the mass balance, the
speciation is computed again, and this loop is repeated until no
supersaturated phases are left in the list. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The real problem
in LMA approach is how to determine the saturation index of the solid
solution
phase or the gas mixture. For the ideal (solid) solution, this can be
done over iterations using ionic mole fractions
available from aqueous speciation. For non-ideal SS, this is a problem
which has
no general solution, as explained on Page 94 in [<a
 href="#Ref_Bruno_ea_2007">Bruno et al, 2007</a>]. Because of that, the
LMA chemical solvers can at best treat only ideal solution phases and
simple binary non-ideal solid solutions that can be described using
Lippmann functions and diagrams. If many solids and/or solid solutions
are potentially present,&nbsp; a simple LMA aqueous
speciation calculation turns into a series of many runs controlled by
non-rigorous
test procedures for selecting (over)saturated solids one-by-one,
without a theoretical guarantee of
convergence to a unique result. This kind of retardation is difficult
to evaluate, but, with a large list of possible condensed phases, more
than ten LMA sub-runs may be required to include all stable solids
into
mass balance.&nbsp;<br>
  </p>
<!--[if gte vml 1]><v:shapetype
 id="_x0000_t75" coordsize="21600,21600" o:spt="75" o:preferrelative="t"
 path="m@4@5l@4@11@9@11@9@5xe" filled="f" stroked="f">
 <v:stroke joinstyle="miter"/>
 <v:formulas>
  <v:f eqn="if lineDrawn pixelLineWidth 0"/>
  <v:f eqn="sum @0 1 0"/>
  <v:f eqn="sum 0 0 @1"/>
  <v:f eqn="prod @2 1 2"/>
  <v:f eqn="prod @3 21600 pixelWidth"/>
  <v:f eqn="prod @3 21600 pixelHeight"/>
  <v:f eqn="sum @0 0 1"/>
  <v:f eqn="prod @6 1 2"/>
  <v:f eqn="prod @7 21600 pixelWidth"/>
  <v:f eqn="sum @8 21600 0"/>
  <v:f eqn="prod @7 21600 pixelHeight"/>
  <v:f eqn="sum @10 21600 0"/>
 </v:formulas>
 <v:path o:extrusionok="f" gradientshapeok="t" o:connecttype="rect"/>
 <o:lock v:ext="edit" aspectratio="t"/>
</v:shapetype><v:shape id="_x0000_i1025" type="#_x0000_t75" style='width:15pt;
 height:20.25pt' o:ole="">
 <v:imagedata src="file:///C:\DOCUME~1\KULIK~1.PSI\LOCALS~1\Temp\msohtml1\01\clip_image001.wmz"
  o:title=""/>
</v:shape><![endif]--><!--[if !vml]--><!--[endif]--><!--[if gte mso 9]><xml>
 <o:OLEObject Type="Embed" ProgID="Equation.3" ShapeID="_x0000_i1025"
  DrawAspect="Content" ObjectID="_1230310185">
 </o:OLEObject>
</xml><![endif]-->
  <p style="font-family: Helvetica,Arial,sans-serif;">These drawbacks
of LMA approach are not relevant in a
complementary GEM approach [for details, see <a
 href="#Ref_Karpov-ea-1997">Karpov et
al., 1997</a>; <a href="#Ref_Karpov-ea-2001">2001</a>; <a
 href="#Ref_Kulik-ea-2004">Kulik et al., 2004</a>; <a
 href="#Ref_Bruno_ea_2007">Bruno et al., 2007</a>], where total mole
amounts of
chemical
elements <span style="font-style: italic;">n<sub>i</sub></span><sub> </sub>and
(zero)
charge <span style="font-style: italic;">n<sub>z</sub></span> comprise
the
input bulk composition of the chemical system expressed using <span
 style="font-style: italic;">n</span>(<span style="font-style: italic;">N</span>)
independent components
(IC). All&nbsp; <span style="font-style: italic;">n</span>(<span
 style="font-style: italic;">L</span>) stoichiometrically
feasible chemical species or dependent
components (DC) are taken
into the mass balance
through their chemical formulae and mole amounts <span
 style="font-style: italic;">n<sub>j</sub></span>. A given <span
 style="font-style: italic;">j</span>-th dependent
component belongs to a single- or
multi-component aqueous, gaseous, fluid, liquid, solid, or sorption
phase.
The stability of <span style="font-style: italic;">j</span>-th DC at
temperature <span style="font-style: italic;">T</span> and pressure <span
 style="font-style: italic;">P</span>
of
interest is defined by its molar Gibbs energy function <span
 style="font-style: italic;">g<sub>T,P</sub></span>. Activities and
concentrations
of dependent components are treated separately in each phase, taking
into account the appropriate standard and
reference states, concentration scales, and models of (non)ideal
mixing. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Conversely,
GEM
algorithms can solve complex Aq-SS
equilibria in one GEM run, in a
straightforward way, without any supporting tools such as Lippmann
functions or semi-empirical iterative procedures required in LMA Aq-SS
speciation
models. The applicability of GEM to chemical systems is limited only by
the knowledge of
standard-state molar properties of end-members and the non-ideal
interaction
parameters for each phase.</p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The
disadvantages of GEM in comparison with LMA codes are (i) slower
convergence in simple aqueous speciation calculations
and (ii) less mass balance accuracy. The performance of GEM can be
dramatically improved using the previous equilibrium speciation as an
initial approximation
for the new run (in "smart initial approximation" mode). The mass
balance accuracy can be made comparable to that of LMA at the cost of a
few additional
GEM iterations (the IPM-2 algorithm), as described in [<a
 href="#Ref_TM-44-02-06">Chudnenko ea,
2002</a>]. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Performance and
chemical feasibility of GEM in complex Aq-SS multiphase
systems may be much better than that of LMA codes
(though no
direct benchmarking is yet available). Another advantage of
GEM method (in "convex programming" variant) is that it yields two
solutions - the "primal" <span style="font-style: italic;">n</span>
for speciation
(analogous to LMA) and the "dual" <span style="font-style: italic;">u</span>
for chemical potentials of
stoichiometry units (not available from LMA solvers). The dual solution
may open
innovative ways to constructing mass transport models for
diffusion-dominated systems, since the
diffusion of any component is driven by the gradient of its chemical
potential.</p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The
present program package GEMIPM2K is an implementation of GEM IPM-2
chemical
solver with a simple data exchange interface that makes it possible to
couple any existing FMT code with the GEM&nbsp; "chemical black box" to
produce a coupled modeling code with high chemical plausibility. As
there is no GUI and data exchange occurs via files or in RAM, such code
can be parallelized and compiled on various platforms up to HPC
clusters.&nbsp; <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The traditional
"operator-splitting" coupling, where the chemical information for all
nodes is
stored in the mass transport part which calls the chemical solver for
each node one-by-one, is
supported by the TNode C++ class (and its fortran interface). When a
new FMT code is written, the whole data storage for all nodes can be
organized using a TNodeArray C++ class into two node arrays (for time t
and t-1), with each node accessible
from the GEM IPM-2 routines or from the FMT program. </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">This
document describes the structure of GEMIPM2K program and the data
exchange interface (DATACH and DATABR structures), followed by an
overview of TNode and TNodeArray classes and examples of their
usage. In a companion document <a href="gemipm2k-inp.html">gemipm2k-inp.html</a>,
the format of GEMIPM2K text input/output files is described together
with the reference on data objects encountered in these files. Most of
these data objects are the same as in GEM-Selektor; hyperlinks are
provided wherever necessary. <br>
  </p>
  <p><br>
  </p>
  <hr size="2" width="100%">
  <h2><br>
  </h2>
  <h2><a name="2-STRUCTURE"></a>2. Structure of GEMIPM2K Code and
its Data Exchange Inteface </h2>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;">GEMIPM2K
package is a set of C++ classes and functions
extracted from the <st1:stockticker w:st="on">GEMS</st1:stockticker>-<st1:stockticker
 w:st="on">PSI</st1:stockticker> code package for thermodynamic
modelling by Gibbs energy minimization (<st1:stockticker w:st="on">GEM</st1:stockticker>).
GEMIPM2K implements the GEM chemical solver linked to TMulti C++ class
and data structure, enhanced with <st1:stockticker w:st="on">RAM</st1:stockticker>-
and file- data exchange interfaces implemented in TNode and TNodeArray
classes. <br>
  </span></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;"><st1:stockticker
 w:st="on"></st1:stockticker> GEMIPM2K has been designed for
coupling the <st1:stockticker w:st="on">GEM</st1:stockticker> chemical
solver with
existing and new fluid-mass-transport (<st1:stockticker w:st="on">FMT</st1:stockticker>)
codes. The program source code is compatible with <st1:stockticker
 w:st="on">ANSI</st1:stockticker>
C++ and can be compiled on many computer platforms (Windows, Linux, <st1:stockticker
 w:st="on">HPC</st1:stockticker> Merlin, Cray XT, etc.) using many
optimizing
compilers (GNU C++, <st1:stockticker w:st="on">PGI</st1:stockticker>
C++, Intel
C++, Microsoft C++, &#8230; ). <br>
  </span></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;">The
input data can be provided in human-readable ASCII files, the
output can also be written in ASCII files. Alternatively, the whole
data
exchange with a transport code part can be performed in <st1:stockticker
 w:st="on">RAM</st1:stockticker>
using&nbsp; DATACH
and&nbsp; DATABR data structures.
This data exchange interface is implemented in two C++ classes &#8211; TNode
and TNodeArray. <br>
  </span></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><span
 style="font-size: 12pt; font-family: Helvetica,Arial,sans-serif;">The
TNode class provides functionality for attaching GEMIPM2K
kernel to an existing transport model code which keeps the chemical
information
for all nodes and calls <st1:stockticker w:st="on">GEM</st1:stockticker>
calculation for each node separately. The TNodeArray class is built on
top of the TNode class and can store both chemical and dynamic data
for all nodes of the mass transport problem. Recalculation of
equilibrium
states in all nodes after the mass transport step can be done with a
single call (with
internal parallelization possible). This may be suitable for developing
of a
new coupled code. The GEMIPM2K source code is expected to be
distributed under
LGPL or similar license.<br>
  <br style="font-family: Helvetica,Arial,sans-serif;">
  </span></p>
  <h3><a name="IPM2-OPERATION"></a>2.1. Brief overview of GEM IPM2
module operation<br>
  </h3>
  <p style="font-family: Helvetica,Arial,sans-serif;">The GEM IPM2
algorithm is described in a companion PSI Technical Report [<a
 href="#Ref_Kulik_ea-2008">Kulik et
al., 2008</a>] , as well as in earlier report [<a
 href="#Ref_TM-44-02-06">Chudnenko et al., 2002</a>]. A short overview
is given in [<a href="#Ref_Bruno_ea_2007">Bruno et al., 2007</a>],
pages 94-104. Recently, the speed of GEM IPM-2 calculations has been
dramatically increased [<a href="#Ref_Dmytrieva-2008">Dmytrieva et al.,
2008</a>] and now is comparable with that of LMA codes, at least in
"smart initial approximation" mode. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The basic idea of
the GEM IPM algorithm consists in finding such a distribution vector <span
 style="font-style: italic;">n </span>of bulk chemical composition of
the system <span style="font-style: italic;">b</span> over its
thermodynamic phases and their components that the total Gibbs energy <span
 style="font-style: italic;">G</span>(<span style="font-style: italic;">n</span>)
of the system is at minimum at temperature and pressure of interest.
Each phase component (chemical species) is represented by its
stoichiometry and the standard chemical potential (molar Gibbs energy
function <span style="font-style: italic;">g</span><sup>o</sup>(<span
 style="font-style: italic;">T,P</span>)) at temperature <span
 style="font-style: italic;">T</span> and pressure <span
 style="font-style: italic;">P</span> of interest. As seen on Fig. 2-1,
the process consists of four major steps. <br>
  <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><img
 alt="Basic GEM IPM flow chart" src="IPM.png"
 style="width: 510px; height: 521px;"></p>
  <p style="font-family: Helvetica,Arial,sans-serif;"><br>
The first step is to obtain an initial approximation of the <span
 style="font-style: italic;">n</span> vector which is close enough to
the <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) minimum, so that the GEM process
would succeed in finding the solution of the problem. In principle, any
previously calculated speciation vector<span style="font-style: italic;">
n</span> for this setup of thermodynamic system (even for different <span
 style="font-style: italic;">b, T, P</span>) can be used as initial
approximation in "smart initial approximation" (SIA) mode. If no
previous solution is available at all, or the available one is bad,
then the so-called "automatic initial approximation" (AIA) must
obtained by solving a linear programming (LP) sub-problem using a
modified simplex method. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The LP
sub-problem is constructed by truncating all the mixing terms from
chemical potential expressions for all components of phases-solutions,
which is equivalent to considering any component as a pure phase. Given
  <span style="font-style: italic;">n</span>(<span
 style="font-style: italic;">N</span>) Independent Components (usually
chemical elements and charge) in the bulk composition vector <span
 style="font-style: italic;">b</span>, the simplex solution contains at
most <span style="font-style: italic;">n</span>(<span
 style="font-style: italic;">N</span>) non-zero elements in the AIA
speciation vector <span style="font-style: italic;">n</span>(AIA).
This is also consistent with the Gibbs phase rule. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Usually, the
number of aqueous species is greater than <span
 style="font-style: italic;">n</span>(<span style="font-style: italic;">N</span>).
If the number of stoichiometrically possible phases exceeds n(N), such
system is called "multisystem" [Karpov et al., 1997]. Equilibria in
multisystems cannot be solved directly by LMA algorithm (see a <a
 href="#CRITIQUE-LMA">comment here</a>), but such equilibria can be
solved in one GEM run, if the initial approximation belongs to the
so-called "feasible domain". So, the second step consists in checking
whether the AIA or SIA vector <span style="font-style: italic;">n</span>
is feasible, i.e. whether the mass balance residuals for all
independent components are small enough. This is usually so in the case
of previously available SIA vector. But the AIA vector contains many
zero amounts of chemical species (dependent components) which may be
relevant aqueous species or form stable condensed or fluid phases,
although this is not a priori known. For that reason, the zero mole
amounts in the AIA initial approximation are filled out with a default
amount (1e-7 - 1e-6 mol) which then would increase or decrease upon GEM
iterations depending on the stability of the chemical species in this
chemical system. If the current amount of <span
 style="font-style: italic;">j</span>-th species <span
 style="font-style: italic;">n<sub>j</sub></span> falls below a certain
numerical threshold (ca. 1e-20 mol), it will be zeroed off. This
eliminates the <span style="font-style: italic;">j</span>-th species
from subsequent GEM iterations in order to avoid numerical troubles.
However, if the total amount of a phase falls below another threshold
(Pa_DS between 1e-9 and 1e-12 mol) then all components in this phase
will be zeroed off and the whole phase is eliminated from next GEM
iterations.<br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The fill-out
procedure in AIA bears also a danger that the mass balance is violated.
Hence, a special EFD() algorithm checks the mass balance residuals and
tries to change the largest elements of the AIA vector in such a way
that the mass balance accuracy would be at least satisfactory (i.e.
deviations less than 1e-7 mol). This is usually done in a few
iterations, and then the initial approximation vector is ready for the
main GEM algorithm. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The third step is
to adjust the elements of <span style="font-style: italic;"></span>speciation
vector <span style="font-style: italic;">n</span> to minimize the
total Gibbs energy of the system <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) while keeping mass balance
deviations the same or lower as inherited from the EFD() step. This is
the core of IPM-2 algorithm - it approaches the GEM problem using the
duality (Kuhn-Tucker) theorem by introducing Lagrange multipliers <span
 style="font-style: italic;">u<sub>i</sub></span> conjugate to the
elements <span style="font-style: italic;">b<sub>i</sub></span> of the
bulk composition vector. These Lagrange multipliers form the so-called
"dual solution" of the GEM problem (the "primal solution" being the <span
 style="font-style: italic;">n</span> speciation vector). The total
Gibbs energy of the system can be calculated either as <span
 style="font-style: italic;">G</span>(<span style="font-style: italic;">n</span>)
= sum(<span style="font-style: italic;">n<sub>j</sub> v<sub>j</sub></span>)
where <span style="font-style: italic;">v<sub>j</sub></span> = <span
 style="font-style: italic;">f</span>(<span style="font-style: italic;">g</span><sup>o</sup><sub><span
 style="font-style: italic;">j</span></sub>, <span
 style="font-style: italic;">n</span>) is the primal chemical potential
of j-th dependent component., or as <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">b</span>) = sum(<span
 style="font-style: italic;">b<sub>i</sub> u<sub>i</sub></span>).
Towards equilibrium, <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) scalar value approaches a
(global) minimum which equals the <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">b</span>) (global) maximum. Hence, the
criterion of convergence can be constructed using any normalized
function of <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) - <span
 style="font-style: italic;">G</span>(<span style="font-style: italic;">b</span>)
which is ideally zero, but numerically must be below a small threshold
(for the quadratic Dikin's criterion, DK &lt; Pa_DK = 1e-4).&nbsp; <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">Each iteration of
IPM consists of three steps. First, a new dual solution approximation <span
 style="font-style: italic;">u</span> is found by solving with the
Cholesky decomposition method a SLE constructed from the previous
primal solution, stoichiometry matrix and weight multipliers. Next, the
vector of descent direction is found by comparing primal and dual
chemical potentials for each dependent component. Finally, a step
length multiplier is determined from a condition that no new nj value
should break the "feasible domain" of mass balance and metastability
constraints. The new approximation of the <span
 style="font-style: italic;">n</span> speciation vector is found by
incrementing non-zero elements of the old one with a product of the
respective element of the descent direction vector and the scalar step
length. Convergence is usually achieved in 1-10 iterations in the SIA
and 20 to 100 iterations in the simplex AIA case. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The fourth step
is called "phase selection" (implemented in PhaseSelect() function). It
consists in calculation of Karpov's phase stability criteria for each
multi-component phase present in non-zero amount, as well as for each
pure phase, either zeroed off or not. The stability criteria have been
derived from the Karpov-Kuhn-Tucker conditions of equilibrium state
that compare primal and dual estimates of chemical potential for each
component. For any stable component in a stable phase, the value of
such criterion must be close to zero.&nbsp; However, if the initial
approximation was bad, or there were errors in stoichiometry or <span
 style="font-style: italic;">g</span><sup>o</sup> value for a dependent
component, <span style="font-style: italic;"></span> the value of
Karpov's criterion may indicate that a phase present in the mass
balance is unstable and must be excluded, or vice versa - a phase
absent from the mass balance (zeroed off) is stable and must be
included. If any such phase has been detected, it is zeroed off
respectively its component amounts are filled out with small amounts,
and the whole sequence is repeated from Step two (but without the
overall fill-out step). If, after three such refinement loops, the
PhaseSelect() still finds inconsistent phases, the behavior of GEM IPM
algorithm depends on the original initial approximation. If it was SIA,
the mode is automatically switched to AIA and calculation begin "from
scratch", i.e. from solving the LP sub-problem for a generic IA. If it
was AIA, an error message is generated and the GEM solution is not
accepted. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">The flow-chart
described above applies when all elements of the bulk composition
vector (except charge) exceed 1e-6 mol. However, if there are some
elements less than 1e-7 mol, the IPM algorithm starting with AIA may
fail with the corresponding mass balance residual which may also be of
the same order of magnitude or even higher (i.e. the mass balance error
may be from 50% to 1000%). The reason for that is the "fill-out" step
spoils the mass balance and the EFD() procedure cannot recover it
completely. In this sutiation, the IPM-2 algorithm is invoked, which in
the case of AIA first runs as the generic IPM algorithm. Even with bad
mass balance precision, this step yields a solution which lies very
close to the <span style="font-style: italic;">G</span>(<span
 style="font-style: italic;">n</span>) minimum and can be used as a
very good initial approximation where the fill-out procedure is not
needed (because all stable phases and components are already known) and
the mass balance residuals thresholds in the EFD-2() procedure can be
set at much lower levels, separately for different independent
components. This is the idea of IPM-2 refinement loops: after
convergence of GEM descent and PhaseSelect() check, an additional check
for the fullfillment of severe mass balance requirements is performed.
If there are still some bad residuals, the loop is repeated with just
obtained approximation of the <span style="font-style: italic;">n</span>
vector from the EFD-2() procedure. In most cases, up to 15 such loops
are sufficient to provide a GEM solution with 0.1% maximum mass balance
residual even for the smallest "trace" independent component present in
1e-14 mol total amount. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">A similar
sequence of refinement loops can be applied when two or more non-ideal
solution phases are present near the critical point of their solvus. In
such a system, the difference in molar Gibbs energy of such phases
becomes tiny and up to 20 refinement GEM-IPM2 runs may be required to
obtain correct speciation. Such systems, however, are rare and in
principle cannot be solved with LMA algorithms. <br>
  </p>
  <p style="font-family: Helvetica,Arial,sans-serif;">All these
numerical paths of the iterative GEM IPM-2 algorithm are controlled
through ca. 20 thersholds and flags, values of which were empirically
found in many test and modelling calculations in various systems. All
these controls can be adjusted in GEMS-PSI GUI window or in the
*ipm.dat input file of GEMIPM2K standalone program. <br>
  <br>
  </p>
  <p>&nbsp;</p>
  <h3><a name="KERNEL"></a>2.2. The GEM-IPM2 Kernel (GEMIPM2K) and its
Work Data
Structure IPM (Multi)<br>
  </h3>
  <p><br>
  <br>
  </p>
  <h3><a name="DATACH"></a>2.3. <font
 style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif">The DATACH Structure for Chemical
System Definition (CSD) Accessible to both FMT and GEM parts</font> </h3>
  <p><br>
  <br>
  </p>
  <p> </p>
  <h3><a name="DATABR"></a>2.4. <font
 face="Helvetica, Arial, sans-serif"><span
 style="font-family: times new roman,times,serif;">The DATABR Structure
for the Node Data Bridge Composition and Speciation data</span> </font>
  </h3>
  <p><br>
  </p>
  <h3><a name="TNODE"></a>2.5. The TNode Class - a Minimum Data
Exchange Interface for Coupling with Existing Transport Codes</h3>
  <br>
  <br>
  <h3><a name="TNODEARRAY"></a>2.6. The TNodeArray Class - a Data
Storage for Developing New Coupled Codes </h3>
  <br>
  <br>
  <p> </p>
  <hr size="2" width="100%">
  <h2><br>
  </h2>
  <h2><a name="REQUIREMENTS"></a>3. Requirements for Programming</h2>
  <p> Geochemical modeling often requires<br>
  </p>
  <p><br>
  <font face="Helvetica, Arial, sans-serif"></font></p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="CALLFROMCPP"></a>3.1. When the Calling (FMT)
Program is Written in C/C++ </h3>
  <p><br>
  </p>
  <p><font face="Helvetica, Arial, sans-serif"><br>
  </font></p>
  <h3><font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><a name="CALLFROMFORTRAN"></a>3.2.
When the
Calling (FMT) Program is Written in Fortran-90 </font><br>
  </h3>
  <p><br>
  </p>
  <p><br>
  <br>
  </p>
  <hr size="2" width="100%"><br>
  <br>
  <br>
  <p> </p>
  <h2><a name="COMPILE_PLATFORMS"></a>4. Compilation and Linking on
Various Platforms <br>
  </h2>
  <dl>
  </dl>
  <br>
introduction <br>
  <br>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="GNUCPP_FOR"></a>4.1. GNU C++ (gcc - gfortran)<br>
  </h3>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="PGICPP_FOR"></a>4.2. Portland Group C++ (pgcc- pgf)<br>
  </h3>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="MSVCPP_DIGIFOR"></a>4.3. MS Visual C++ (with Digital Fortran)<br>
  </h3>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="BORLANDCPP"></a>4.4. Borland C++<br>
  </h3>
  <font face="Helvetica, Arial, sans-serif"><br>
  <br>
  </font>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="OTHER_COMPILERS"></a>4.5. Other compilers and linkers</h3>
  <br>
  <font face="Helvetica, Arial, sans-serif"><br>
  </font>
  <h3 style="font-family: times new roman,times,serif;"><a
 name="SVN_REP"></a>4.6. Subversion Repository of GEMIPM2K<br>
  </h3>
  <br>
  <dl>
    <br>
  </dl>
&nbsp; <br>
  <hr size="2" width="100%"><br>
  <h2><a name="INPUT_FILES"></a>5. Input Files <br>
  </h2>
  <p> Geochemical modeling often requires&nbsp; </p>
  <p><br>
  </p>
&nbsp; <br>
  <hr size="2" width="100%"><br>
  <h2><a name="TEST_EXAMPLES"></a>6. Test Examples <br>
  </h2>
  <p> Geochemical modeling often requires&nbsp; </p>
  <p style="font-family: times new roman,times,serif;"><br>
  </p>
  <h3><font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><a name="TEST_TNODE"></a>6.1.
TNode Level</font></h3>
  <font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"></font> <font
 style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><br>
  <br>
  </font>
  <h3><font style="font-family: times new roman,times,serif;"
 face="Helvetica, Arial, sans-serif"><a name="TEST_TNODEARRAY"></a>6.2.
TNodeArray Level</font></h3>
  <dl>
    <br style="font-family: times new roman,times,serif;">
    <span style="font-family: times new roman,times,serif;">&nbsp; </span><br>
    <br>
  </dl>
  <hr size="2" width="100%"><br>
  <h2><a name="REFERENCES"></a>7. References</h2>
  <a name="Ref_Bethke-1996"></a> Bethke, 1996 (<a
 href="http://hercules.geology.uiuc.edu/%7Ebethke/hydro_gwb.htm">http://hercules.geology.uiuc.edu/~bethke/hydro_gwb.htm</a>)<br>
  <br>
  <a name="Ref_Bruno_ea_2007"></a> Bruno J.,
Bosbach D., Kulik D., Navrotsky A. (2007): <i>Chemical
thermodynamics of solid solutions of interest in radioactive waste
management: A state-of-the art report</i>, Eds.
F.J.Mompean, M.Illemassene, J.Perrone, Chemical Thermodynamics Series
Vol. <span style="font-weight: bold;">10</span>, Paris, OECD, 292 p.
(<a href="http://www.nea.fr/html/dbtdb/info/publications/welcome.html">http://www.nea.fr/html/dbtdb/info/publications/welcome.html</a>)<br>
  <br>
  <a name="Ref_TM-44-02-06"></a> Chudnenko K.V. et al. TM-44-02-06 <br>
  <br>
  <a name="Ref_Dmytrieva-2008"></a>Dmytrieva S.V. et al. 2008
TM-44-08-XY<br>
  <br>
  <a name="Ref_Karpov-ea-2001"></a> Karpov I.K.,
Chudnenko
K.V., Kulik D.A., Avchenko O.V. and Bychinski V.A. (2001). Minimization
of Gibbs free energy in geochemical systems by convex programming.
Geochemistry International <span style="font-weight: bold;">39</span>(11),
1108-1119. <br>
  <br>
  <a name="Ref_Karpov-ea-1997"></a> Karpov I.K.,
Chudnenko
K.V.
and Kulik D.A. (1997): Modeling chemical mass-transfer in geochemical
processes: Thermodynamic relations, conditions of equilibria and
numerical algorithms.
American Journal of Science <span style="font-weight: bold;">297</span>,
767-806<br>
  <br>
  <a name="Ref_Kulik-ea-2004"></a> Kulik D.,
Berner U., Curti E.
(2004): Modelling chemical equilibrium partitioning with the GEMS-PSI
code. In: PSI Scientific Report 2003 / Volume <span
 style="font-weight: bold;">IV</span>, Nuclear Energy and
Safety (edited by B.Smith and B.Gschwend), Paul Scherrer Institute,
Villigen, Switzerland, March 2004, p.109-122 (ISSN 1423-7334) (<a
 href="http://gems.web.psi.ch/">http://gems.web.psi.ch/</a>)<br>
  <br>
  <a name="Ref_Kulik_ea-2008"></a> Kulik D. et al. (2008) TM-44-08-XX<br>
  <br>
  <a name="Ref_Morel-Hering-1993"></a> Morel and Hering, 1993 <br>
  <br>
  <a name="Ref_Parkhurst-Appelo-1999"></a> Parkhurst and Appelo, 1999 (<a
 href="http://wwwbrr.cr.usgs.gov/projects/GWC_coupled/phreeqc/%29">http://wwwbrr.cr.usgs.gov/projects/GWC_coupled/phreeqc/)</a><br>
  <br>
  <a name="Ref_Reed-1982"></a> Reed, 1982<br>
  <br>
  <a name="Ref_van-der-Lee-1998"></a> van der Lee J. (1998):
Thermodynamic and mathematical concepts of CHESS, Technical Report Nr.
LHM/RD/98/39, Ecole des Mines de Paris, Fontaineleau, France&nbsp; (<a
 href="http://chess.ensmp.fr/doc.html">http://chess.ensmp.fr/doc.html</a>).<br>
  <br>
  <a name="Ref_Van-Zeggeren-1970"></a> Van Zeggeren and Storey,
1970<br>
  <br>
  <br>
  <br>
To
Contents
&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;<tt>About GEMIPM2K </tt><br>
  <tt><br>
end of file</tt> <br>
&nbsp;<br>
  <p><br>
&nbsp; </p>
  <br>
  <br>
</blockquote>
</body>
</html>
